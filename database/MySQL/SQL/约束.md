# **约束（Constraint）**就是**限制表中数据的规则**，用来保证数据的**完整性**和**有效性**。
---
## 1. 为什么要有约束

- **防止脏数据**：比如年龄不能为负数、学号不能重复。
    
- **保证业务一致性**：比如订单必须关联已存在的用户。
    
- **减少程序端重复校验**：数据库自身帮你检查。
---
## 2. 常见约束类型（MySQL）

| 约束                 | 作用   | 特点               | 示例                                          |
| ------------------ | ---- | ---------------- | ------------------------------------------- |
| **NOT NULL**       | 禁止为空 | 列必须有值            | `age INT NOT NULL`                          |
| **DEFAULT**        | 默认值  | 插入时没指定就用它        | `status TINYINT DEFAULT 1`                  |
| **UNIQUE**         | 唯一约束 | 列值不能重复（可为 NULL）  | `email VARCHAR(50) UNIQUE`                  |
| **PRIMARY KEY**    | 主键   | 唯一且非空，自动建索引      | `id INT PRIMARY KEY`                        |
| **AUTO_INCREMENT** | 自增   | 整型列自动递增（需配主键/唯一） | `id INT PRIMARY KEY AUTO_INCREMENT`         |
| **CHECK**（8.0+）    | 检查条件 | 插入/更新时必须满足表达式    | `CHECK (age >= 0)`                          |
| **FOREIGN KEY**    | 外键   | 保证值来自另一表         | `FOREIGN KEY (dept_id) REFERENCES dept(id)` |

---

## 3. 示例
```sql
CREATE TABLE student (     
	id INT PRIMARY KEY AUTO_INCREMENT COMMENT '学号',
	name VARCHAR(20) NOT NULL COMMENT '姓名', 
	age INT CHECK (age >= 0 AND age <= 120) 
	COMMENT '年龄', 
	email VARCHAR(50) UNIQUE COMMENT '邮箱',     
	class_id INT,     
	FOREIGN KEY (class_id) REFERENCES class(id) )
	COMMENT='学生表';
```

---

## 4. 约束的作用范围

- **列级约束**：定义在单个列上（`NOT NULL`、`DEFAULT` 等）。
    
- **表级约束**：定义在多个列上（复合主键、复合唯一、外键等）。
    

---

## 5. 注意事项

1. **NOT NULL ≠ UNIQUE**：非空不代表唯一，唯一不代表非空。
    
2. **外键约束可能影响性能**：高并发写入时要谨慎。
    
3. **CHECK** 在 MySQL 8.0 之前虽然可以写，但不会生效（会被忽略）。
    
4. 可以用 `SHOW CREATE TABLE 表名;` 查看已有约束。
---
# 外键约束（**FOREIGN KEY Constraint**）是 一种**保证表与表之间数据关联一致性**的规则。  
它的作用是：确保某列（或多列）的值**必须来自另一张表的某列**，这样就避免了“孤儿数据”
---
## 1. 核心概念

- **外键列**：在当前表（子表）中，被约束的列。
    
- **主表（父表）**：被外键引用的表。
    
- **引用列**：主表中被引用的列，通常是主键或唯一键。
    
- **作用**：防止插入无效引用，防止删除/修改导致引用失效。
![[Pasted image 20250812164831.png]]

---

## 2. 基本语法
```sql
CREATE TABLE 子表 (
    列名 数据类型,
    ...
    FOREIGN KEY (外键列)
    REFERENCES 主表(被引用列)
    [ON UPDATE 动作]
    [ON DELETE 动作]
);
```

```sql
-- 部门表（父表）
CREATE TABLE dept (
    dept_id INT PRIMARY KEY,
    dept_name VARCHAR(50) NOT NULL
);

-- 员工表（子表）
CREATE TABLE emp (
    emp_id INT PRIMARY KEY,
    emp_name VARCHAR(50) NOT NULL,
    dept_id INT,
    FOREIGN KEY (dept_id) REFERENCES dept(dept_id)
        ON UPDATE CASCADE
        ON DELETE RESTRICT
);
```
### 作用：

1. **插入检查**
    - `emp.dept_id` 必须存在于 `dept.dept_id` 中，否则插入失败。    
2. **更新行为**（`ON UPDATE`）
    - 如果主表的 `dept_id` 改了，子表对应的 `dept_id` 会自动更新（CASCADE）。
3. **删除行为**（`ON DELETE`）
    
    - `NO ACTION`, `RESTRICT`：不允许删除有员工的部门。
        
    - `CASCADE`：删除部门时自动删除所有关联员工。
        
    - `SET NULL`：删除部门时把员工的 `dept_id` 置空。
        
    - `NO ACTION`：与 `RESTRICT` 类似（MySQL 中等效）
	    
    - `SET DEFAULT`: 父表有变更，子表外建列设置成一个默认值（Innodb 不支持）
---
## 4. 注意事项

1. **存储引擎必须支持外键**
    
    - MySQL 里只有 **InnoDB** 支持外键约束，MyISAM 不支持。
        
2. **引用列必须有索引**
    
    - 主表引用列必须是主键或唯一键。
        
3. **外键列类型必须匹配**
    
    - 数据类型、长度、符号（SIGNED/UNSIGNED）必须一致。
        
4. **外键会影响删除/更新性能**
    
    - 因为要检查和维护一致性。
        
5. **外键检查可临时关闭**
```sql
	SET FOREIGN_KEY_CHECKS = 0; -- 关闭 
	SET FOREIGN_KEY_CHECKS = 1; -- 开启
```

---

## 5. 查询已有外键信息

```sql
SHOW CREATE TABLE emp; 
-- 或 
SELECT * FROM information_schema.KEY_COLUMN_USAGE
WHERE TABLE_NAME = 'emp';
```