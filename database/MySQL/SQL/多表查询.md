# 多表查询（**Multi-table Query**）就是一次 `SELECT` 同时从**两张或多张表**取数据的查询方式，它是关系型数据库的核心功能之一。

## 多表关系

- 一对多（多对一）
	![[Pasted image 20250812172423.png]]
- 多对多
	![[Pasted image 20250812172531.png]]
- 一对一
	![[Pasted image 20250812173650.png]]
	

## 2 多表查询的方式

### ① 连接查询（JOIN）

按关联条件把多表数据**横向组合**。常见类型：

| 类型                   | 作用                   | 示例                                                                             |
| -------------------- | -------------------- | ------------------------------------------------------------------------------ |
| **INNER JOIN**（内连接）  | 只保留两表匹配的行            | `SELECT e.name, d.dept_name FROM emp e INNER JOIN dept d ON e.dept_id = d.id;` |
| **LEFT JOIN**（左连接）   | 保留左表所有行，右表没匹配的补 NULL | `SELECT e.name, d.dept_name FROM emp e LEFT JOIN dept d ON e.dept_id = d.id;`  |
| **RIGHT JOIN**（右连接）  | 保留右表所有行，左表没匹配的补 NULL | `SELECT e.name, d.dept_name FROM emp e RIGHT JOIN dept d ON e.dept_id = d.id;` |
| **CROSS JOIN**（笛卡尔积） | 不加条件，返回两表所有行组合       | `SELECT * FROM emp CROSS JOIN dept;`                                           |

```sql
--- 内连接
-- 隐式
SELECT 列名
FROM 表1 [AS 别名1], 表2 [AS 别名2]
where 条件

-- 显式
SELECT 列名
FROM 表1 [AS 别名1]
INNER JOIN 表2 [AS 别名2]
ON 表1.列 = 表2.列;

-- 外连接
SELECT e.name, d.dept_name 
FROM emp e 
LEFT JOIN dept d 
ON e.dept_id = d.id;

SELECT e.name, d.dept_name 
FROM emp e 
RIGHT JOIN dept d 
ON e.dept_id = d.id;

-- 自链接
SELECT 列名
FROM 表1 [AS 别名1]
JOIN 表1 [AS 别名2]
ON 表1.列 = 表1.列;

SELECT 列名
FROM 表1 [AS 别名1]
LEFT JOIN 表1 [AS 别名2]
ON 表1.列 = 表1.列;
```


---
### ② 子查询（Subquery）

一个查询的结果作为另一个查询的输入。

```sql
SELECT 列
FROM 表
WHERE 列 运算符 (SELECT ...);
-- 查工资最高的员工
SELECT * FROM emp
WHERE salary = (SELECT MAX(salary) FROM emp);
```
###  子查询的分类

### 按**返回值**分类

#### 1.标量子查询（Scalar Subquery）

- **返回单个值**（单行单列）
    
- 常用于比较运算符：`=`, `<`, `>`, `<=`, `>=`
```sql
-- 查询工资等于最高工资的员工 
SELECT name, salary FROM emp WHERE salary = (SELECT MAX(salary) FROM emp);
```
#### 2.列子查询（Column Subquery）

- **返回一列多行**
    
- 常配合 `IN`、`NOT IN`、`ANY`、`ALL`、`SOME`
```sql
-- 查询属于 IT 或 HR 部门的员工
SELECT name
FROM emp
WHERE dept_id IN (SELECT id FROM dept WHERE dept_name IN ('IT', 'HR'));
```
#### 3. 行子查询（Row Subquery）

- **返回一行多列**（少见）
    
- 用于多列比较
```sql
-- 查询工资和奖金与 'Tom' 相同的员工
SELECT name
FROM emp
WHERE (salary, bonus) = (SELECT salary, bonus FROM emp WHERE name = 'Tom');
```
#### 4. 表子查询（Table Subquery）

- **返回多行多列**

- 常用于 `FROM` 子句，把子查询当成临时表（派生表）

```sql
-- 查询每个部门的最高工资
SELECT dept_id, MAX(salary) AS max_salary
FROM emp
GROUP BY dept_id;

-- 外层查询用这个结果
SELECT t.dept_id, t.max_salary
FROM (SELECT dept_id, MAX(salary) AS max_salary
      FROM emp
      GROUP BY dept_id) AS t
WHERE t.max_salary > 10000;
```

---
### ③ 联合查询（UNION / UNION ALL）

把多个查询结果**纵向合并**。
```sql
SELECT name, phone FROM customers
UNION [ALL]
SELECT name, phone FROM suppliers;

-- UNION ALL 不去重，效率更高
-- 查询列数保持一致，字段类型保持一致
```
---
3️⃣ 示例：
```sql
-- 员工表
emp(emp_id, emp_name, dept_id)
-- 部门表
dept(dept_id, dept_name)

-- 查询员工姓名和所在部门名称
SELECT e.emp_name, d.dept_name
FROM emp e
JOIN dept d ON e.dept_id = d.dept_id;
```
结果：

|emp_name|dept_name|
|---|---|
|Tom|HR|
|Rose|IT|
|Jack|Sales|

---